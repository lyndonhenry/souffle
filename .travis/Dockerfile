ARG SOUFFLE_DOCKER_BASE_IMAGE

FROM ${SOUFFLE_DOCKER_BASE_IMAGE}

ARG CC
ARG CXX

ARG SOUFFLE_CATEGORY
ARG SOUFFLE_CONFS
ARG SOUFFLE_CONFIGURE_OPTIONS
ARG SOUFFLE_MAKE_JOBS

ENV CC="${CC}"
ENV CXX="${CXX}"

ENV SOUFFLE_CATEGORY="${SOUFFLE_CATEGORY}"
ENV SOUFFLE_CONFS="${SOUFFLE_CONFS}"
ENV SOUFFLE_CONFIGURE_OPTIONS="${SOUFFLE_CONFIGURE_OPTIONS}"
ENV SOUFFLE_MAKE_JOBS="${SOUFFLE_MAKE_JOBS}"

COPY . /home/souffle/souffle

WORKDIR /home/souffle/souffle

# @TODO: this gives a too many arguments error...
USER root

RUN chown -R souffle .
# RUN ulimit -c unlimited -S
USER souffle

RUN ./bootstrap
RUN ./configure ${SOUFFLE_CONFIGURE_OPTIONS}
RUN make -j${SOUFFLE_MAKE_JOBS}

#RUN if [[ "${SOUFFLE_CATEGORY}" != *"Unit"* ]]; then cd tests; fi
#ENV TESTSUITEFLAGS="-j${SOUFFLE_MAKE_JOBS}"
#ENTRYPOINT ["make", "check", "-j${SOUFFLE_MAKE_JOBS}"]
